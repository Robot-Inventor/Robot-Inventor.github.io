<!DOCTYPE html><html lang=ja><head prefix="og: http://ogp.me/ns#"><link rel=preconnect href=https://fonts.gstatic.com crossorigin=""><link rel=preconnect href=https://fonts.googleapis.com> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-140830854-3"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-140830854-3")</script> <link rel=preconnect href=https://www.google-analytics.com> <meta charset=UTF-8> <meta http-equiv=X-UA-Compatible content="IE=edge"> <meta name=viewport content="width=device-width,initial-scale=1"> <link rel=stylesheet href=/src/css/index.min.css> <link rel=apple-touch-icon sizes=180x180 href=/src/icon/favicon/apple-touch-icon.png> <link rel=icon type=image/png sizes=32x32 href=/src/icon/favicon/favicon-32x32.png> <link rel=icon type=image/png sizes=16x16 href=/src/icon/favicon/favicon-16x16.png> <link rel=manifest href=/src/icon/favicon/site.webmanifest> <link rel=mask-icon href=/src/icon/favicon/safari-pinned-tab.svg color=#ffa4a4> <link rel="shortcut icon"href=/src/icon/favicon/favicon.ico> <link rel=alternate type=application/rss+xml title="Robot Inventor RSS Feed"href=https://robot-inventor.github.io/rss.xml> <meta name=apple-mobile-web-app-title content="Robot Inventor"> <meta name=application-name content="Robot Inventor"> <meta name=msapplication-TileColor content=#2d89ef> <meta name=msapplication-config content=/src/icon/favicon/browserconfig.xml> <meta name=theme-color content=#ffffff> <title>ページのAMP化でつまずいたこと - Robot Inventor</title> <meta name=author content=Robot-Inventor> <meta name=description content=ブログをAMPに対応させました。途中でいくつかつまずいた点があったので記事にします。> <meta property=og:url content=https://robot-inventor.github.io/article/2020/05/12> <meta property=og:type content=article> <meta property=og:title content="ページのAMP化でつまずいたこと - Robot Inventor"> <meta property=og:description content=ブログをAMPに対応させました。途中でいくつかつまずいた点があったので記事にします。> <meta property=og:site_name content="Robot Inventor"> <meta property=og:image content=https://robot-inventor.github.io/article/2020/05/12/flash-845848_1920.jpg> <meta name=twitter:card content=summary_large_image> <meta name=twitter:site content=@keita_roboin> <link rel=preload as=style href=/src/css/vs2015.min.css onload='this.rel="stylesheet"'><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap"onload='this.rel="stylesheet"'><script type=application/ld+json> {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "url": "https://robot-inventor.github.io/",
      "name": "Robot Inventor",
      "alternateName": "Robot Inventor",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://robot-inventor.github.io/article/2020/05/12"
      },
      "headline": "ページのAMP化でつまずいたこと",
      "description": "ブログをAMPに対応させました。途中でいくつかつまずいた点があったので記事にします。",
      "image": ["flash-845848_1920.jpg"],
      "author": {
        "@type": "Person",
        "name": "Robot-Inventor",
        "url": "https://robot-inventor.github.io/",
        "sameAs": "https://twitter.com/keita_roboin"
      },
      "datePublished": "2020-05-12T00:00:00.000+09:00",
      "dateModified": "2022-04-05T23:04:58.299+09:00"
    } </script></head> <body> <header> <button id=menu_icon title=メニュー> <div id=menu_icon_line_top></div> <div id=menu_icon_line_center></div> <div id=menu_icon_line_bottom></div> </button> <a href=/ id=top_link> <span id=site_logo_placeholder>ROBOT INVENTOR</span> <img data-src=/src/icon/logo.svg data-alt="ROBOT INVENTOR"id=site_logo> </a> <div id=menu_overlay></div> <div id=menu_bar> <div id=menu_bar_contents> <div> <a href=/ >トップへ</a> </div> <div> <a href=/article>記事一覧</a> </div> <div> <a href=/notice>お知らせ</a> </div> </div> </div> </header> <main id=article_container> <article id=article_container_inner> <h1 id=ページのamp化でつまずいたこと>ページのAMP化でつまずいたこと</h1><div id=article_date_information> <div id=posted_date title=投稿日時> <picture> <source media="(prefers-color-scheme: dark)"srcset=/src/icon/article_white.svg loading=lazy decoding=async alt=アイコン> <img src=/src/icon/article_black.svg loading=lazy decoding=async alt=アイコン> </picture> 作成：<time datetime=2020-05-12T00:00:00.000+09:00>2020-05-12　00:00</time> </div> <div id=last_updated_date title=最終更新日時> <picture> <source media="(prefers-color-scheme: dark)"srcset=/src/icon/edit_white.svg loading=lazy decoding=async alt=アイコン> <img src=/src/icon/edit_black.svg loading=lazy decoding=async alt=アイコン> </picture> 最終更新：<time datetime=2022-04-05T23:04:58.299+09:00>2022-04-05　23:04</time> </div> </div> <div class=note-info> <div class=note-content> <p>この記事と同じ内容を<a href=https://qiita.com/Robot-Inventor/items/9dfd2f4d0a674e43150f>Qiita</a>にも投稿してあります。また2021年6月11日現在、ブログの改修にともない、本ブログのAMPサポートは終了しました。</p> </div> </div> <p><a href=flash-845848_1920.jpg><picture><source srcset=optimized_images/flash-845848_1920_1920px.avif type=image/avif media="(min-width: 960px)"><source srcset="optimized_images/flash-845848_1920_960px.avif, optimized_images/flash-845848_1920_1920px.avif 2x"type=image/avif media="(min-width: 480px) and (max-width: 960px)"><source srcset="optimized_images/flash-845848_1920_480px.avif, optimized_images/flash-845848_1920_1920px.avif 4x, optimized_images/flash-845848_1920_960px.avif 2x"type=image/avif media="(max-width: 480px)"><source srcset=optimized_images/flash-845848_1920_1920px.webp type=image/webp media="(min-width: 960px)"><source srcset="optimized_images/flash-845848_1920_960px.webp, optimized_images/flash-845848_1920_1920px.webp 2x"type=image/webp media="(min-width: 480px) and (max-width: 960px)"><source srcset="optimized_images/flash-845848_1920_480px.webp, optimized_images/flash-845848_1920_1920px.webp 4x, optimized_images/flash-845848_1920_960px.webp 2x"type=image/webp media="(max-width: 480px)"><img loading=lazy decoding=async src=flash-845848_1920.jpg alt=木に雷が落ちている画像 width=1920 height=1456></picture></a></p> <p>とうとう本ブログもAMPに対応し、ページの読み込み速度が改善されました。</p> <p>AMPに対応させる前は画像の遅延読み込みだけでなくscriptタグにdefer属性を付けたりpreloadやpreconnectを使ったりなどのさまざまな工夫をしていました。しかし、AMPにしたらそんなことをしなくても高速になりました。</p> <p>また、AMPとは関係ありませんが、日本語Webフォントをなくしただけで<a href="https://developers.google.com/speed/pagespeed/insights/?hl=JA">Page Speed Insights</a>のモバイルの点数が30点上がりました。</p> <p>この記事では、AMP化のときにつまずいたことや、解決した方法を書いていきます。そもそもAMPの概要や対応方法を知りたいという場合は他の記事を見てください。</p> <h2 id=1-amp-imgの終了タグ>1. amp-imgの終了タグ</h2> <p>amp-imgタグはimgタグと違い終了タグが必要です。終了タグがなくても正常に動く場合もありますが、画像が引き伸ばされたり場所がずれたりします。</p> <p>最初は原因がわからなかったのですが、公式サイトを読んでいるうちに「あれ？終了タグ付け忘れていた」となりました。</p> <p>それに気づいたのは、ほぼ全ページAMP化が終わったあとでした。記事数が少なかったおかげでAMP化の作業は1日くらいで終わりましたが、さすがに全ページにamp-imgの終了タグを付けていくのはきついです。</p> <p>ということで、Pythonに自動で修正させました。プログラムはすでに作ってあった「全ページ共通のインラインCSSやheader、footerを自動で書き換える」プログラムをベースに作ったのですぐにできました。</p> <h2 id=2-amp-imgのフォールバックが機能しない>2. amp-imgのフォールバックが機能しない</h2> <p>amp-imgタグのフォールバックが機能せず悩んでいたのですが、 <a href=https://amp.dev/ja/documentation/guides-and-tutorials/develop/style_and_layout/placeholders/#%E3%83%95%E3%82%A9%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF>公式サイトの「プレースホルダーとフォールバック」</a>に、さらっと書いてあります。</p> <blockquote> <p>fallback 属性は、AMP 要素だけでなく、どの HTML 要素でも設定できます。指定する場合、fallback 要素は AMP 要素の直接の子にする必要があります。</p> <p><a href=https://amp.dev/ja/documentation/guides-and-tutorials/develop/style_and_layout/placeholders/ >https://amp.dev/ja/documentation/guides-and-tutorials/develop/style_and_layout/placeholders/</a>より</p> </blockquote> <p>ということで、フォールバックはフォールバックでない要素の子要素にする必要があります。悪い例を見てみましょう。</p> <pre><code class="language-html hljs language-xml"><span class=hljs-tag>&lt;<span class=hljs-name>amp-img</span> <span class=hljs-attr>src</span>=<span class=hljs-string>"path_to_image"</span> <span class=hljs-attr>alt</span>=<span class=hljs-string>""</span> <span class=hljs-attr>width</span>=<span class=hljs-string>"1920"</span> <span class=hljs-attr>height</span>=<span class=hljs-string>"1080"</span> <span class=hljs-attr>layout</span>=<span class=hljs-string>"responsive"</span>></span><span class=hljs-tag>&lt;/<span class=hljs-name>amp-img</span>></span>
<span class=hljs-tag>&lt;<span class=hljs-name>amp-img</span> <span class=hljs-attr>fallback</span> <span class=hljs-attr>src</span>=<span class=hljs-string>"path_to_fallback_image"</span> <span class=hljs-attr>alt</span>=<span class=hljs-string>""</span> <span class=hljs-attr>width</span>=<span class=hljs-string>"1920"</span> <span class=hljs-attr>height</span>=<span class=hljs-string>"1080"</span> <span class=hljs-attr>layout</span>=<span class=hljs-string>"responsive"</span>></span><span class=hljs-tag>&lt;/<span class=hljs-name>amp-img</span>></span>
</code></pre> <p>フォールバックは子要素にしなければいけません。</p> <p>最初これで書いてしまっていて、全ページを修正するはめになりました。</p> <p>上の悪い例を修正するとこうなります。</p> <pre><code class="language-html hljs language-xml"><span class=hljs-tag>&lt;<span class=hljs-name>amp-img</span> <span class=hljs-attr>src</span>=<span class=hljs-string>"path_to_image"</span> <span class=hljs-attr>alt</span>=<span class=hljs-string>""</span> <span class=hljs-attr>width</span>=<span class=hljs-string>"1920"</span> <span class=hljs-attr>height</span>=<span class=hljs-string>"1080"</span> <span class=hljs-attr>layout</span>=<span class=hljs-string>"responsive"</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>amp-img</span> <span class=hljs-attr>fallback</span> <span class=hljs-attr>src</span>=<span class=hljs-string>"path_to_fallback_image"</span> <span class=hljs-attr>alt</span>=<span class=hljs-string>""</span> <span class=hljs-attr>width</span>=<span class=hljs-string>"1920"</span> <span class=hljs-attr>height</span>=<span class=hljs-string>"1080"</span> <span class=hljs-attr>layout</span>=<span class=hljs-string>"responsive"</span>></span><span class=hljs-tag>&lt;/<span class=hljs-name>amp-img</span>></span>
<span class=hljs-tag>&lt;/<span class=hljs-name>amp-img</span>></span>
</code></pre> <p>ちゃんと子要素になっていますね。</p> <h2 id=3-cssのobject-fitを使った画像の切り抜きができない>3. CSSのobject-fitを使った画像の切り抜きができない</h2> <p>このブログでは、このページの一番上にあるように、画像を貼っています。そして、その画像はCSSのobject-fitをつかって切り抜いているのですがAMPにしたら切り抜かれず、無理やり引き伸ばされてしまいました。</p> <p>解決方法は、 公式サイトの<a href=https://amp.dev/documentation/examples/style-layout/how_to_support_images_with_unknown_dimensions/#object-fit-to-the-rescue>「How to support Images with unknown Dimensions」</a>のObject-Fit to the rescueのobject-fit: coverの方に書かれていました。</p> <p>ページ自体は「サイズがわからない画像ってどうすればいいの？」という内容ですが、CSSのobject-fitでトリミングする方法も書かれていました。</p> <p>レスポンシブに画像を正方形に切り抜くならこんな感じでしょうか。</p> <p>CSS</p> <pre><code class="language-css hljs"><span class=hljs-selector-class>.cropping-container</span> {
    <span class=hljs-attribute>position</span>: relative;
    <span class=hljs-attribute>width</span>: <span class=hljs-number>100vw</span>;
    <span class=hljs-attribute>height</span>: <span class=hljs-number>100vw</span>;
}

<span class=hljs-selector-class>.cropping-container</span> amp-<span class=hljs-selector-tag>img</span>,
<span class=hljs-selector-class>.cropping-container</span> <span class=hljs-selector-tag>img</span> {
    <span class=hljs-attribute>object-fit</span>: cover;
}
</code></pre> <p>HTML</p> <pre><code class="language-html hljs language-xml"><span class=hljs-tag>&lt;<span class=hljs-name>div</span> <span class=hljs-attr>class</span>=<span class=hljs-string>"cropping-container"</span>></span>
    <span class=hljs-tag>&lt;<span class=hljs-name>amp-img</span> <span class=hljs-attr>layout</span>=<span class=hljs-string>"fill"</span> <span class=hljs-attr>src</span>=<span class=hljs-string>"path_to_image"</span>></span><span class=hljs-tag>&lt;/<span class=hljs-name>amp-img</span>></span>
<span class=hljs-tag>&lt;/<span class=hljs-name>div</span>></span>
</code></pre> <p>ちなみに、CSSにamp-imgだけでなく普通のimgもありますが、これを消すと上手く動きません。これは、AMPのスクリプトがimgタグを使って画像を表示しているからです。</p> <h2 id=4-直書きのsvg画像のエラー>4. 直書きのSVG画像のエラー</h2> <p><a href="https://search.google.com/test/amp?hl=JA">AMPテスト</a>をしたら、SVGのxmlns:dc、paint-order、gとかが許可されてないよ☆的なこと言われました。</p> <p>そのため、テキストエディターでSVGを開いて許可されてないと言われたものを消していきました。</p> <p>ただし、paint-orderとgタグは削除すると画像が破壊されることもあるので、ブラウザーなどで画像をプレビューしながら作業することをオススメします。</p> <p>また、上で挙げた許可されていないものはすべて小文字にされていましたが、実際のSVGのデータは大文字も混ざっているので検索するときは気をつけてください。</p> <p>paint-orderはフィルやストロークの重なりの順番を指定するものです。ストロークの塗りがなければ消してもおそらく問題ないでしょう。</p> <p>しかし、ストロークを使って袋文字（縁取りのある文字）などを作っている場合は注意が必要です。場合によってはpaint-orderを消すと縁取りが外側だけでなく内側にも付いてしまいます。</p> <p>その場合はSVGエディターを使って袋文字の上に袋文字でない（＝ストロークの塗りがない）ものを重ねてからpaint-orderを消せばうまくいくはずです（試していません）。</p> <p>また、gタグについては、gタグにstyle属性が使われている場合、自分で消さないほうがいいです。gタグはグループ化をしているので、SVGエディターですべてのグループ化を解除すれば直接ファイルをいじらずに解決します。</p> <p>ただし、画像を編集しやすくするなどの理由があってグループ化しているはずなので、もとの画像のバックアップを取っておいたほうがいいです。</p> <p>SVGの作成には<a href=https://inkscape.org/ >Inkscape</a>を使っていて、SVGファイルをテキストエディターで開くと「inkscape」という文字列を含んだ属性があったので、それらも削除しました。</p> <p>最後に注意点として、頑張って削除した属性やタグは、Inkscapeで開いて保存すると復活するので気をつけてください。</p> <h2 id=さいごに>さいごに</h2> <p>こんな感じで、色々ありながら、Pythonの力も借りながらほぼすべてのページをAMP化しました。</p> <p>今回は維持・管理のしやすさから、AMP化したページは通常のHTMLページを用意していませんが、IEのアクセスも考えるなら通常のHTML版も用意する必要があります。</p> <p>AMP化の作業は、ページ数が少ないにもかかわらず丸1日潰れました。</p> <p>ちなみに新型コロナウイルスの影響で休校中だったので気分転換にやったのですが、全然気分転換にはなりませんでした...。</p> <p>今回はページ数が少なかったので1人でできましたが、普通のサイトではAMP化のツールを使ったり、WordPressならプラグインを使ったりするべきです。</p> <p>ということで、最後までお読みいただき、ありがとうございました。</p> </article> </main> <footer> <span id=copyright></span> <p> <a href=/tos/ >利用規約</a>・<a href=/privacy/ >プライバシーポリシー</a> </p> <p> <a href=https://twitter.com/keita_roboin>Twitter</a>・<a href=https://github.com/Robot-Inventor>GitHub</a> </p> </footer> <script src=/src/js/index.min.js></script> 